<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Buttons Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root {
      --background: #ffffff;
      --foreground: #0f172a;
      --card: #ffffff;
      --card-foreground: #0f172a;
      --muted: #f1f5f9;
      --muted-foreground: #64748b;
      --border: #e2e8f0;
      --input: #e2e8f0;
      --primary: #0f172a;
      --primary-foreground: #f8fafc;
      --secondary: #f1f5f9;
      --secondary-foreground: #0f172a;
      --accent: #f1f5f9;
      --accent-foreground: #0f172a;
      --ring: #94a3b8;
      --radius: 0.5rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--background);
      color: var(--foreground);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      padding: 16px;
      max-width: 100%;
    }

    .week-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex-wrap: wrap;
    }

    .week-nav button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--foreground);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .week-nav button:hover {
      background: var(--accent);
      border-color: var(--border);
    }

    .week-nav button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--background), 0 0 0 4px var(--ring);
    }

    .week-nav button:active {
      transform: scale(0.98);
    }

    .week-label {
      font-weight: 600;
      font-size: 14px;
      color: var(--foreground);
      min-width: 160px;
      text-align: center;
      padding: 0 8px;
    }

    .week-status {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .week-status-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted-foreground);
    }

    .today-btn {
      background: var(--primary) !important;
      color: var(--primary-foreground) !important;
      border-color: var(--primary) !important;
    }

    .today-btn:hover {
      opacity: 0.9;
      background: var(--primary) !important;
    }

    .records-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .record {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: box-shadow 0.15s ease;
    }

    .record:hover {
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    .record-info {
      flex: 1;
      min-width: 0;
    }

    .title {
      font-weight: 500;
      font-size: 14px;
      color: var(--foreground);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .details {
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted-foreground);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    .buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .status-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border: 1px solid transparent;
      border-radius: calc(var(--radius) - 2px);
      background: var(--secondary);
      color: var(--muted-foreground);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .status-btn:hover {
      background: var(--accent);
      color: var(--accent-foreground);
    }

    .status-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--background), 0 0 0 4px var(--ring);
    }

    .status-btn:active {
      transform: scale(0.97);
    }

    .status-btn.active {
      font-weight: 600;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      background: var(--primary);
      color: var(--primary-foreground);
    }

    .no-records, .config-message {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted-foreground);
      text-align: center;
      padding: 48px 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
    }

    /* Responsive styles */
    @media (max-width: 640px) {
      #app {
        padding: 12px;
      }

      .week-nav {
        padding: 12px;
        gap: 6px;
      }

      .week-nav button {
        padding: 8px 12px;
        font-size: 13px;
      }

      .week-label {
        width: 100%;
        order: -1;
        margin-bottom: 8px;
        font-size: 13px;
        min-width: unset;
      }

      .nav-buttons {
        display: flex;
        gap: 6px;
        width: 100%;
        justify-content: center;
      }

      .record {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 14px;
      }

      .title {
        font-size: 15px;
        text-align: left;
      }

      .buttons {
        justify-content: flex-start;
        gap: 8px;
      }

      .status-btn {
        flex: 1;
        min-width: calc(50% - 4px);
        max-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 400px) {
      .week-nav button {
        padding: 6px 10px;
        font-size: 12px;
      }

      .week-label {
        font-size: 12px;
      }

      .status-btn {
        min-width: 100%;
        max-width: 100%;
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .week-nav button,
      .status-btn {
        min-height: 44px;
      }

      .status-btn {
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="config-message">Loading...</div>
  </div>

  <script>
    let records = [];
    let statusChoices = [];
    let tableId = null;
    let statusColumnId = null;
    let statusColumnType = null;
    let dateColumnId = null;
    let currentWeekStart = getWeekStart(new Date());

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeekEnd(weekStart) {
      const end = new Date(weekStart);
      end.setDate(end.getDate() + 6);
      end.setHours(23, 59, 59, 999);
      return end;
    }

    function formatWeekLabel(weekStart) {
      const weekEnd = getWeekEnd(weekStart);
      const opts = { month: 'short', day: 'numeric' };
      const startStr = weekStart.toLocaleDateString('en-US', opts);
      const endStr = weekEnd.toLocaleDateString('en-US', { ...opts, year: 'numeric' });
      return `${startStr} – ${endStr}`;
    }

    function prevWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      render();
    }

    function nextWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      render();
    }

    function goToToday() {
      currentWeekStart = getWeekStart(new Date());
      render();
    }

    function isInCurrentWeek(dateValue) {
      if (!dateColumnId) return true;
      if (dateValue === null || dateValue === undefined) return false;
      
      let recordDate;
      if (dateValue instanceof Date) {
        recordDate = dateValue;
      } else if (typeof dateValue === 'number') {
        recordDate = new Date(dateValue * 1000);
      } else if (typeof dateValue === 'string') {
        recordDate = new Date(dateValue);
      } else if (typeof dateValue === 'object' && dateValue.getTime) {
        recordDate = new Date(dateValue.getTime());
      } else {
        return false;
      }
      
      if (isNaN(recordDate.getTime())) return false;
      const weekEnd = getWeekEnd(currentWeekStart);
      return recordDate >= currentWeekStart && recordDate <= weekEnd;
    }

    grist.ready({
      columns: [
        { name: 'Title', title: 'Title', type: 'Text', optional: true },
        { name: 'Status', title: 'Status', type: 'RefList' },
        { name: 'Date', title: 'Date', type: 'Date,DateTime', description: 'Date or DateTime column', optional: true },
        { name: 'Details', title: 'Details', type: 'Text', optional: true }
      ],
      requiredAccess: 'full'
    });

    grist.onRecords((data, mappings) => {
      records = grist.mapColumnNames(data) || [];
      console.info('Records updated', { recordCount: records.length, mappings });
      if (mappings) {
        statusColumnId = mappings.Status || null;
        dateColumnId = mappings.Date || null;
        if (statusColumnId) {
          fetchStatusChoices();
        }
      }
      render();
    });

    grist.on('message', (msg) => {
      if (msg.tableId) {
        tableId = msg.tableId;
        console.info('Table selected', { tableId });
        if (statusColumnId) {
          fetchStatusChoices();
        }
      }
    });

    function getDisplayColId(tables, columns, refTableId) {
      const tableRefIndex = tables.tableId.indexOf(refTableId);
      const tableRef = tableRefIndex === -1 ? null : tables.id[tableRefIndex];
      if (!tableRef) return null;

      let displayColId = null;
      if (tables.displayCol && tables.displayCol[tableRefIndex]) {
        const displayRef = tables.displayCol[tableRefIndex];
        const displayColIndex = columns.id.indexOf(displayRef);
        if (displayColIndex !== -1) {
          displayColId = columns.colId[displayColIndex];
        }
      }

      if (!displayColId && Array.isArray(columns.isDisplayCol)) {
        const displayColIndex = columns.id.findIndex((id, i) =>
          columns.parentId[i] === tableRef && columns.isDisplayCol[i]
        );
        if (displayColIndex !== -1) {
          displayColId = columns.colId[displayColIndex];
        }
      }

      if (!displayColId) {
        const firstColIndex = columns.id.findIndex((id, i) => columns.parentId[i] === tableRef);
        if (firstColIndex !== -1) {
          displayColId = columns.colId[firstColIndex];
        }
      }

      return displayColId;
    }

    async function fetchStatusChoices() {
      if (!statusColumnId || !tableId) return;

      statusChoices = [];
      statusColumnType = null;

      try {
        const tables = await grist.docApi.fetchTable('_grist_Tables');
        const columns = await grist.docApi.fetchTable('_grist_Tables_column');

        const tableRefIndex = tables.tableId.indexOf(tableId);
        const tableRef = tableRefIndex === -1 ? null : tables.id[tableRefIndex];
        if (!tableRef) {
          console.warn('Table reference not found for status column', { tableId });
          return;
        }

        const colIndex = columns.id.findIndex((id, i) =>
          columns.parentId[i] === tableRef && columns.colId[i] === statusColumnId
        );
        if (colIndex === -1) {
          console.warn('Status column not found', { tableId, statusColumnId });
          return;
        }

        statusColumnType = columns.type[colIndex] || null;
        if (!statusColumnType || !statusColumnType.startsWith('RefList')) {
          console.warn('Status column must be RefList', { statusColumnType });
          render();
          return;
        }

        const refTableId = getRefTableIdFromType(statusColumnType);
        if (!refTableId) {
          console.warn('Unable to parse ref table id', { statusColumnType });
          return;
        }

        const displayColId = getDisplayColId(tables, columns, refTableId);
        const refTable = await grist.docApi.fetchTable(refTableId);
        const ids = refTable.id || [];
        const labels = displayColId ? (refTable[displayColId] || []) : [];
        statusChoices = ids.map((id, i) => {
          const label = labels[i] !== undefined && labels[i] !== null ? labels[i] : id;
          return { label: `${label}`, value: id };
        });

        console.info('Status choices ready', { choiceCount: statusChoices.length });
        render();
      } catch (e) {
        console.error('Failed to load status choices:', e);
      }
    }

    function getRefTableIdFromType(type) {
      if (!type) return null;
      const match = type.match(/^Ref(List)?:([^:]+)$/);
      return match ? match[2] : null;
    }


    function extractRefId(value) {
      if (value === null || value === undefined) return null;
      if (typeof value === 'number') return value;
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return null;
        const num = Number(trimmed);
        return Number.isNaN(num) ? null : num;
      }
      if (typeof value === 'object') {
        if (value.id !== undefined) return extractRefId(value.id);
        if (value.value !== undefined) return extractRefId(value.value);
      }
      return null;
    }

    function coerceRefListValue(value) {
      if (value === null || value === undefined) return [];
      if (Array.isArray(value)) {
        return value.map(extractRefId).filter(id => typeof id === 'number' && !Number.isNaN(id));
      }
      const id = extractRefId(value);
      return id === null ? [] : [id];
    }

    async function changeStatus(rowId, newStatus) {
      try {
        const table = await grist.selectedTable;
        await table.update({ id: rowId, fields: { Status: coerceRefListValue(newStatus) } });
      } catch (e) {
        console.error('Failed to update status:', e);
      }
    }

    async function changeWeekStatus(newStatus) {
      try {
        const table = await grist.selectedTable;
        const weekRecords = records.filter(r => isInCurrentWeek(r.Date));
        for (const record of weekRecords) {
          await table.update({ id: record.id, fields: { Status: coerceRefListValue(newStatus) } });
        }
        render();
      } catch (e) {
        console.error('Failed to update week status:', e);
      }
    }

    function getOptionLabel(option) {
      if (!option) return '';
      if (option.label === null || option.label === undefined) return '';
      return `${option.label}`;
    }

    function areValuesEqual(a, b) {
      if (a === b) return true;
      if (a === null || a === undefined || b === null || b === undefined) return false;
      if (statusColumnType && statusColumnType.startsWith('RefList')) {
        const aList = Array.isArray(a) ? a : [a];
        const bList = Array.isArray(b) ? b : [b];
        return aList.some(value => bList.some(other => JSON.stringify(value) === JSON.stringify(other)));
      }
      if (a instanceof Date && b instanceof Date) return a.getTime() === b.getTime();
      return JSON.stringify(a) === JSON.stringify(b);
    }

    function serializeOptionValue(value) {
      if (value === undefined) return 'null';
      if (value instanceof Date) {
        return JSON.stringify({ __type: 'Date', value: value.toISOString() });
      }
      return JSON.stringify(value);
    }

    function parseOptionValue(value) {
      if (!value) return null;
      try {
        const parsed = JSON.parse(value);
        if (parsed && typeof parsed === 'object' && parsed.__type === 'Date') {
          return new Date(parsed.value);
        }
        return parsed;
      } catch (e) {
        return null;
      }
    }

    function encodeHtmlAttribute(value) {
      return `${value}`
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function bindStatusButtons() {
      const app = document.getElementById('app');
      app.onclick = (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const value = parseOptionValue(button.dataset.value);
        if (button.dataset.action === 'week') {
          changeWeekStatus(value);
          return;
        }
        if (button.dataset.action === 'status') {
          const rowId = Number(button.dataset.rowId);
          if (Number.isNaN(rowId)) return;
          changeStatus(rowId, value);
        }
      };
    }

    function getRecordOptions() {
      return statusChoices;
    }

    function render() {
      const app = document.getElementById('app');

      if (statusColumnType && !statusColumnType.startsWith('RefList')) {
        app.innerHTML = '<div class="config-message">Status column must be a RefList.</div>';
        return;
      }

      const filteredRecords = records.filter(r => isInCurrentWeek(r.Date));
      const weekStatuses = statusChoices;
      const weekStatusButtons = weekStatuses.map(option => {
        return `
          <button class="status-btn" 
            data-action="week"
            data-value="${encodeHtmlAttribute(serializeOptionValue(option.value))}">
            ${escapeHtml(getOptionLabel(option))}
          </button>
        `;
      }).join('');
      const weekStatusControls = weekStatuses.length ? `
        <div class="week-status">
          <span class="week-status-label">Set week:</span>
          ${weekStatusButtons}
        </div>
      ` : '';

      const weekNav = `
        <div class="week-nav">
          <span class="week-label">${formatWeekLabel(currentWeekStart)}</span>
          <div class="nav-buttons">
            <button onclick="prevWeek()">← Prev</button>
            <button class="today-btn" onclick="goToToday()">Today</button>
            <button onclick="nextWeek()">Next →</button>
          </div>
          ${weekStatusControls}
        </div>
      `;

      if (filteredRecords.length === 0) {
        app.innerHTML = weekNav + '<div class="no-records">No records for this week</div>';
        bindStatusButtons();
        return;
      }

      app.innerHTML = weekNav + '<div class="records-container">' + filteredRecords.map(record => {
        const title = record.Title || '(no title)';
        const details = record.Details || '';
        const currentStatus = record.Status;
        const recordOptions = getRecordOptions();
        const detailsHtml = details ? `<div class="details">${escapeHtml(details)}</div>` : '';

        return `
          <div class="record">
            <div class="record-info">
              <div class="title">${escapeHtml(title)}</div>
              ${detailsHtml}
            </div>
            <div class="buttons">
              ${recordOptions.map(option => {
                const isActive = areValuesEqual(option.value, currentStatus);
                const activeClass = isActive ? 'active' : '';
                return `
                  <button class="status-btn ${activeClass}" 
                    data-action="status"
                    data-row-id="${record.id}"
                    data-value="${encodeHtmlAttribute(serializeOptionValue(option.value))}">
                    ${escapeHtml(getOptionLabel(option))}
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('') + '</div>';
      bindStatusButtons();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text === null || text === undefined ? '' : `${text}`;
      return div.innerHTML;
    }
  </script>
</body>
</html>
