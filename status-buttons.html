<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Buttons Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fff;
    }
    .week-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    .week-nav button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.15s;
    }
    .week-nav button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }
    .week-label {
      font-weight: 600;
      font-size: 15px;
      color: #333;
      min-width: 200px;
      text-align: center;
    }
    .today-btn {
      font-size: 13px !important;
      padding: 6px 12px !important;
    }
    .record {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    .record:last-child {
      border-bottom: none;
    }
    .title {
      flex: 1;
      font-weight: 500;
      color: #333;
    }
    .current-status {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      background: #e3f2fd;
      color: #1565c0;
      font-weight: 500;
    }
    .buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .status-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }
    .status-btn:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }
    .no-records {
      color: #666;
      text-align: center;
      padding: 40px;
    }
    .config-message {
      color: #666;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="config-message">Loading...</div>
  </div>

  <script>
    let records = [];
    let statusChoices = [];
    let choiceStyles = {};
    let tableId = null;
    let statusColumnId = null;
    let currentWeekStart = getWeekStart(new Date());

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeekEnd(weekStart) {
      const end = new Date(weekStart);
      end.setDate(end.getDate() + 6);
      end.setHours(23, 59, 59, 999);
      return end;
    }

    function formatWeekLabel(weekStart) {
      const weekEnd = getWeekEnd(weekStart);
      const opts = { month: 'short', day: 'numeric' };
      const startStr = weekStart.toLocaleDateString('en-US', opts);
      const endStr = weekEnd.toLocaleDateString('en-US', { ...opts, year: 'numeric' });
      return `${startStr} – ${endStr}`;
    }

    function prevWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      render();
    }

    function nextWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      render();
    }

    function goToToday() {
      currentWeekStart = getWeekStart(new Date());
      render();
    }

    function isInCurrentWeek(dateValue) {
      console.log(dateValue);
      console.log(typeof(dateValue));
      if (dateValue === null || dateValue === undefined) return false;
      // Grist Date and DateTime are Unix timestamps in seconds
      const timestamp = typeof dateValue === 'number' ? dateValue : Number(dateValue);
      if (isNaN(timestamp)) return false;
      const recordDate = new Date(timestamp * 1000);
      const weekEnd = getWeekEnd(currentWeekStart);
      return recordDate >= currentWeekStart && recordDate <= weekEnd;
    }

    grist.ready({
      columns: [
        { name: 'Title', title: 'Title', type: 'Text' },
        { name: 'Status', title: 'Status', type: 'Choice' },
        { name: 'Date', title: 'Date', type: 'Date,DateTime', description: 'Date or DateTime column' }
      ],
      requiredAccess: 'full'
    });

    grist.onRecords((data, mappings) => {
      records = grist.mapColumnNames(data) || [];
      if (mappings && mappings.Status) {
        statusColumnId = mappings.Status;
        fetchStatusChoices();
      }
      render();
    });

    grist.on('message', (msg) => {
      if (msg.tableId) {
        tableId = msg.tableId;
        if (statusColumnId) {
          fetchStatusChoices();
        }
      }
    });

    async function fetchStatusChoices() {
      if (!statusColumnId || !tableId) return;

      try {
        const tables = await grist.docApi.fetchTable('_grist_Tables');
        const columns = await grist.docApi.fetchTable('_grist_Tables_column');

        const tableRef = tables.id[tables.tableId.indexOf(tableId)];
        if (!tableRef) return;

        const colIndex = columns.id.findIndex((id, i) => 
          columns.parentId[i] === tableRef && columns.colId[i] === statusColumnId
        );
        if (colIndex === -1) return;

        const colType = columns.type[colIndex];
        if (!colType || !colType.startsWith('Choice')) return;

        const widgetOptions = columns.widgetOptions[colIndex];
        if (!widgetOptions) return;

        const options = JSON.parse(widgetOptions);
        if (options.choices && Array.isArray(options.choices)) {
          statusChoices = options.choices;
          choiceStyles = options.choiceOptions || {};
          render();
        }
      } catch (e) {
        console.error('Failed to fetch status choices:', e);
      }
    }

    async function changeStatus(rowId, newStatus) {
      try {
        const table = await grist.selectedTable;
        await table.update({ id: rowId, fields: { Status: newStatus } });
      } catch (e) {
        console.error('Failed to update status:', e);
      }
    }

    function getAvailableStatuses() {
      return statusChoices;
    }

    function render() {
      const app = document.getElementById('app');

      const filteredRecords = records.filter(r => isInCurrentWeek(r.Date));

      const weekNav = `
        <div class="week-nav">
          <button onclick="prevWeek()">← Prev</button>
          <span class="week-label">${formatWeekLabel(currentWeekStart)}</span>
          <button onclick="nextWeek()">Next →</button>
          <button class="today-btn" onclick="goToToday()">Today</button>
        </div>
      `;

      if (filteredRecords.length === 0) {
        app.innerHTML = weekNav + '<div class="no-records">No records for this week.</div>';
        return;
      }

      const allStatuses = getAvailableStatuses();

      app.innerHTML = weekNav + filteredRecords.map(record => {
        const title = record.Title || '(no title)';
        const currentStatus = record.Status || '';

        return `
          <div class="record">
            <div class="title">${escapeHtml(title)}</div>
            <div class="buttons">
              ${allStatuses.map(status => {
                const style = choiceStyles[status] || {};
                const isActive = status === currentStatus;
                const bgColor = isActive ? (style.fillColor || '#e0e0e0') : '#e0e0e0';
                const textColor = isActive ? (style.textColor || '#333') : '#888';
                const activeStyle = isActive ? 'font-weight: 600;' : '';
                return `
                  <button class="status-btn" 
                    style="background: ${bgColor}; color: ${textColor}; border-color: ${bgColor}; ${activeStyle}"
                    onclick="changeStatus(${record.id}, '${escapeJs(status)}')">
                    ${escapeHtml(status)}
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeJs(text) {
      return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }
  </script>
</body>
</html>
